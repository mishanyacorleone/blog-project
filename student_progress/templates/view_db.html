{% extends 'base.html' %}

{% block title %}База данных студентов{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Записи из базы данных</h2>

    <div class="input-group mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Поиск по имени или предмету...">
    </div>

    {% if students %}
        <table class="table table-striped table-bordered mt-3" id="grades-table">
            <thead class="table-dark">
                <tr>
                    <th>Имя студента</th>
                    <th>Предмет</th>
                    <th>Оценка</th>
                    <th>Действие</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for student in students %}
                <tr data-id="{{ student.id }}">
                    <td contenteditable="true" class="editable" data-field="student_name">{{ student.student_name }}</td>
                    <td contenteditable="true" class="editable" data-field="subject">{{ student.subject }}</td>
                    <td contenteditable="true" class="editable" data-field="grade">{{ student.grade }}</td>
                    <td>
                        <button class="btn btn-danger btn-sm delete-btn">Удалить</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="text-center mt-3">
            <button id="save-changes" class="btn btn-success">Сохранить</button>
        </div>

    {% else %}
        <p class="text-muted">В базе данных пока нет записей.</p>
    {% endif %}
</div>

<script>
document.getElementById("searchInput").addEventListener("input", function() {
    const query = this.value;

    fetch(`{% url 'student_progress:ajax_search' %}?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = "";

            data.results.forEach(item => {
                const row = document.createElement("tr");
                row.setAttribute("data-id", item.id);
                row.innerHTML = `
                    <td contenteditable="true" class="editable" data-field="student_name">${item.student_name}</td>
                    <td contenteditable="true" class="editable" data-field="subject">${item.subject}</td>
                    <td contenteditable="true" class="editable" data-field="grade">${item.grade}</td>
                    <td><button class="btn btn-danger btn-sm delete-btn">Удалить</button></td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(err => console.error("Ошибка при поиске:", err));
});

document.addEventListener("DOMContentLoaded", () => {
    const saveBtn = document.getElementById("save-changes");
    const table = document.getElementById("grades-table");

    // Отслеживание изменений
    const editedRows = new Set();
    table.addEventListener("input", (e) => {
        if (e.target.classList.contains("editable")) {
            const row = e.target.closest("tr");
            editedRows.add(row);
        }
    });

    // Сохранение всех изменений одной кнопкой
    saveBtn.addEventListener("click", () => {
        const updates = [];

        editedRows.forEach(row => {
            const id = row.dataset.id;
            const rowData = {};
            row.querySelectorAll(".editable").forEach(cell => {
                rowData[cell.dataset.field] = cell.innerText.trim();
            });
            updates.push({ id, ...rowData });
        });

        if (updates.length === 0) {
            alert("Нет изменений для сохранения");
            return;
        }

        fetch("{% url 'student_progress:update_all' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ updates })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                alert("Изменения успешно сохранены");
                editedRows.clear();
            } else {
                alert("Ошибка при сохранении: " + data.error);
            }
        })
        .catch(() => alert("Ошибка соединения с сервером"));
    });

    // Удаление строки
    table.addEventListener("click", (e) => {
        if (e.target.classList.contains("delete-btn")) {
            const row = e.target.closest("tr");
            console.log(row);
            const id = row.getAttribute('data-id');
            console.log(id);
            if (confirm("Удалить запись?")) {
                fetch(`/student_progress/delete/${id}/`, {
                    method: "POST",
                    headers: { "X-CSRFToken": "{{ csrf_token }}" }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        row.remove();
                    } else {
                        alert("Ошибка: " + data.error);
                    }
                });
            }
        }
    });
});
</script>

{% endblock %}
